<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallet Dashboard</title>
  <link rel="stylesheet" href="/public/shared/app.css" />
</head>
<body>
<div class="wrap">
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>BitcoinII Wallet</b>
        <span class="mono" id="userLine">loading…</span>
      </div>
    </div>

    <div class="navlinks">
      <a href="/">Health</a>
      <a href="/explorer">Explorer</a>
      <a class="active" href="/app/dashboard.html">Wallet</a>
    </div>

    <div class="pillrow">
      <div class="pill">Balance <b id="bal">-</b></div>
      <div class="pill">Unconf <b id="unconf">-</b></div>
      <div class="pill">Txs <b id="txcount">-</b></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Wallet</h2>
        <div class="tabs">
          <a class="tab active" href="/app/dashboard.html" style="text-decoration:none;">Overview</a>
          <a class="tab" href="/app/receive.html" style="text-decoration:none;">Receive</a>
          <a class="tab" href="/app/send.html" style="text-decoration:none;">Send</a>
          <a class="tab" href="/app/settings.html" style="text-decoration:none;">Settings</a>
        </div>
      </div>

      <div id="overview" class="loading" style="margin-top:10px;">Loading…</div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn" id="createWalletBtn">Create Wallet (once)</button>
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
      <div id="msg" class="sub" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2>Latest Transactions</h2>
      <div id="txs" class="loading">Loading…</div>
    </div>
  </div>
</div>

<script>
  async function jfetch(url, opts) {
    const res = await fetch(url, Object.assign({ headers: { "content-type": "application/json" } }, opts));
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  }

  async function ensureLogin() {
    const me = await fetch("/api/auth/me").then(r => r.json()).catch(() => ({}));
    if (!me.user) location.href = "/app/login";
    document.getElementById("userLine").textContent = "User: " + me.user.username;
    return me.user;
  }

  function renderTxs(txs) {
    if (!txs.length) return "<div class='sub'>No transactions yet.</div>";
    return `
      <div class="kvs">
        ${txs.slice(0, 15).map(t => `
          <div class="kv">
            <div class="k mono">${new Date((t.time||0)*1000).toLocaleString()}</div>
            <div class="v mono">${t.category || ""} ${t.amount ?? ""} (conf: ${t.confirmations ?? ""})</div>
            <div class="sub mono">${t.txid || ""}</div>
          </div>
        `).join("")}
      </div>
    `;
  }

  async function load() {
    await ensureLogin();

    const sum = await jfetch("/api/wallet/summary", { method: "GET" });
    document.getElementById("bal").textContent = sum.balance;
    document.getElementById("unconf").textContent = sum.unconfirmed;
    document.getElementById("txcount").textContent = sum.txcount;

    document.getElementById("overview").classList.remove("loading");
    document.getElementById("overview").innerHTML = `
      <div class="kvs">
        <div class="kv"><div class="k">Wallet</div><div class="v mono">${sum.wallet}</div></div>
        <div class="kv"><div class="k">Descriptors</div><div class="v mono">${sum.descriptors}</div></div>
      </div>
      <div class="sub" style="margin-top:10px;">
        Tip: Use “Receive” to generate a fresh address like Core wallet.
      </div>
    `;

    const tx = await jfetch("/api/wallet/txs?n=25", { method: "GET" });
    document.getElementById("txs").classList.remove("loading");
    document.getElementById("txs").innerHTML = renderTxs(tx.txs || []);
  }

  document.getElementById("refreshBtn").onclick = () => load().catch(e => {
    document.getElementById("msg").textContent = "Error: " + e.message;
  });

  document.getElementById("createWalletBtn").onclick = async () => {
    const msg = document.getElementById("msg");
    msg.textContent = "Creating wallet…";
    try {
      const r = await jfetch("/api/wallet/create", { method: "POST", body: "{}" });
      msg.textContent = "OK: " + JSON.stringify(r.result || r);
      await load();
    } catch (e) {
      msg.textContent = "Error: " + e.message;
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await jfetch("/api/auth/logout", { method: "POST", body: "{}" }).catch(() => {});
    location.href = "/app/login";
  };

  // basic client idle logout (server also enforces)
  let last = Date.now();
  ["mousemove","keydown","click","touchstart"].forEach(ev => window.addEventListener(ev, () => last = Date.now()));
  setInterval(async () => {
    if (Date.now() - last > 15 * 60_000) {
      await fetch("/api/auth/logout", { method: "POST", headers: { "content-type": "application/json" }, body: "{}" }).catch(()=>{});
      location.href = "/app/login";
    }
  }, 5000);

  load().catch(e => {
    if (String(e.message || e).includes("not_logged_in") || String(e.message || e).includes("session_expired")) {
      location.href = "/app/login";
    }
    document.getElementById("msg").textContent = "Error: " + e.message;
  });
</script>
</body>
</html>
